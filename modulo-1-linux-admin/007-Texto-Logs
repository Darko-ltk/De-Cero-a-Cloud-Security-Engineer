DÃA 7: MANIPULACIÃ“N DE TEXTO Y ANÃLISIS DE LOGS

Objetivo: Dominar las herramientas de manipulaciÃ³n de texto para el anÃ¡lisis forense de logs y la detecciÃ³n de incidentes

FUNDAMENTOS DEL ANÃLISIS DE LOGS
La Importancia CrÃ­tica de los Logs en Ciberseguridad
Como futuro Cloud Security Engineer, los logs son tus "ojos" en el sistema. No son simples archivos de texto; son la fuente de verdad forense que te permite:
    â€¢ Reconstruir Incidentes: Entender la secuencia de acciones de un atacante.
    â€¢ Detectar Amenazas en Tiempo Real: Identificar actividad maliciosa mientras ocurre.
    â€¢ AuditorÃ­a y Compliance: Demostrar el cumplimiento de normativas de seguridad.
    â€¢ Troubleshooting de Seguridad: Diagnosticar por quÃ© una configuraciÃ³n de seguridad no funciona como se espera.
    â€¢ AnÃ¡lisis de Causa RaÃ­z (RCA): Determinar el origen exacto de una brecha de seguridad.
Ubicaciones Clave de Logs en Ubuntu Server

Debes conocer estas ubicaciones como la palma de tu mano[1]:
    â€¢ /var/log/auth.log: CRÃTICO. Registra todos los intentos de autenticaciÃ³n, exitosos y fallidos, y el uso de sudo. Tu primera parada para investigar accesos no autorizados[1].
    â€¢ /var/log/syslog: Registro general del sistema. Contiene mensajes de una gran variedad de servicios y del kernel[1].
    â€¢ /var/log/kern.log: Mensajes especÃ­ficos del kernel. Ãštil para diagnosticar problemas de hardware o drivers[1].
    â€¢ /var/log/unattended-upgrades/: Logs de las actualizaciones automÃ¡ticas de seguridad.
    â€¢ /var/log/apt/history.log: Historial de instalaciÃ³n y eliminaciÃ³n de paquetes con apt.
    â€¢ /var/log/ufw.log: Actividad del firewall UFW (si estÃ¡ habilitado).
    â€¢ /var/log/fail2ban.log: Logs de los baneos de IPs (si Fail2Ban estÃ¡ instalado).

HERRAMIENTAS ESENCIALES DE MANIPULACIÃ“N DE TEXTO
RedirecciÃ³n y TuberÃ­as (Pipes): El Flujo de Datos
Dominar el flujo de datos es esencial para cualquier anÃ¡lisis complejo[2].
    â€¢ TuberÃ­a (|): Encadena comandos. La salida del comando1 se convierte en la entrada del comando2[2].
comando1 | comando2
    â€¢ RedirecciÃ³n de Salida (>): EnvÃ­a la salida a un archivo nuevo, sobrescribiÃ©ndolo si ya existe[2].
comando > archivo_nuevo.txt
    â€¢ AÃ±adir a un Archivo (>>): EnvÃ­a la salida a un archivo existente, aÃ±adiÃ©ndola al final[2].
comando >> archivo_existente.txt
Comando grep: El BisturÃ­ para Buscar Patrones
grep es tu herramienta principal para filtrar y encontrar informaciÃ³n especÃ­fica en grandes volÃºmenes de datos[3].
Sintaxis BÃ¡sica:
# Buscar una cadena de texto en un archivo
grep "Failed password" /var/log/auth.log

# Buscar recursivamente en un directorio y sus subdirectorios
sudo grep -r "error" /var/log/

BÃºsqueda Avanzada con Expresiones Regulares:
# Buscar lÃ­neas que comienzan con "sshd"
grep "^sshd" /var/log/auth.log

# Buscar lÃ­neas que contienen direcciones IP (patrÃ³n simple)
grep -E "[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}" /var/log/auth.log

# Mostrar lÃ­neas que contienen "accepted" O "failed"
grep -E "accepted|failed" /var/log/auth.log

# Invertir la bÃºsqueda (mostrar todo excepto el patrÃ³n)
grep -v "CRON" /var/log/syslog

# Mostrar N lÃ­neas antes (-B) y despuÃ©s (-A) del patrÃ³n
grep -A 2 -B 1 "session opened" /var/log/auth.log

Comando sed: El Editor de Flujos para Modificar Texto
sed (Stream Editor) te permite realizar transformaciones de texto sobre la marcha[3].
SustituciÃ³n de Texto:
# Reemplazar la primera ocurrencia de "string1" por "string2" en cada lÃ­nea
sed 's/string1/string2/' archivo.txt

# Reemplazar TODAS las ocurrencias (modificador 'g' de global)
sed 's/string1/string2/g' archivo.txt

# Ejemplo prÃ¡ctico: Anonimizar IPs en un log para un informe
cat /var/log/auth.log | sed 's/[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}/IP_ANONIMIZADA/g'

EliminaciÃ³n de LÃ­neas:
# Eliminar lÃ­neas en blanco
sed '/^$/d' archivo.txt

# Eliminar lÃ­neas que contienen "DEBUG"
sed '/DEBUG/d' /var/log/syslog

# Eliminar la primera lÃ­nea de un archivo
sed '1d' archivo.txt

Comando awk: El Procesador de Texto por Columnas
awk es una herramienta de programaciÃ³n extremadamente potente para procesar datos estructurados en columnas[3].
Sintaxis BÃ¡sica:
# Imprimir la primera columna ($1) y la tercera ($3) de un archivo
awk '{print $1, $3}' archivo.txt

Ejemplos de Seguridad:
# Extraer las IPs de intentos de login fallidos
sudo grep "Failed password" /var/log/auth.log | awk '{print $11}'

# Contar el nÃºmero de intentos fallidos por usuario
sudo grep "Failed password" /var/log/auth.log | awk '{print $9}' | sort | uniq -c | sort -nr

# Mostrar los procesos que consumen mÃ¡s de 10% de CPU
ps aux | awk '$3 > 10.0 {print $0}'

Comandos sort, uniq, wc y cut: Las Utilidades Esenciales
    â€¢ sort: Ordena las lÃ­neas de texto.
        â—¦ -n: Orden numÃ©rico.
        â—¦ -r: Orden inverso.
    â€¢ uniq: Filtra o cuenta lÃ­neas duplicadas adyacentes.
        â—¦ -c: Cuenta las ocurrencias de cada lÃ­nea.
    â€¢ wc: Cuenta lÃ­neas (-l), palabras (-w) y caracteres (-c).
    â€¢ cut: Extrae secciones (columnas) de cada lÃ­nea.
        â—¦ -d: Especifica el delimitador.
        â—¦ -f: Especifica los campos (columnas) a extraer.

ANÃLISIS DE LOGS EN LA PRÃCTICA
MetodologÃ­a de AnÃ¡lisis de Incidentes
Basado en las mejores prÃ¡cticas de la industria, un anÃ¡lisis de logs sigue estos pasos[4]:
    1. Identificar Fuentes de Logs: Saber quÃ© logs son relevantes para el incidente.
    2. Centralizar y Copiar: Copiar los logs a un lugar seguro para no alterar la evidencia.
    3. Minimizar Ruido: Filtrar eventos benignos y repetitivos.
    4. Validar Timestamps: Asegurarse de que las fechas y horas son correctas.
    5. Buscar AnomalÃ­as: Errores, fallos, cambios de estado, eventos de acceso inusuales.
    6. Reconstruir la LÃ­nea de Tiempo: Ir hacia atrÃ¡s y adelante en el tiempo para entender la secuencia de eventos.
    7. Correlacionar Logs: Unir informaciÃ³n de diferentes fuentes (auth.log, syslog, logs de aplicaciÃ³n) para obtener una visiÃ³n completa[4].

Comando journalctl: El Visor Moderno de Logs
Para sistemas con systemd, journalctl es la herramienta principal para consultar el journal[5].
# Ver todos los logs del sistema
journalctl

# Ver los logs en tiempo real (similar a tail -f)
journalctl -f

# Filtrar por un servicio especÃ­fico
journalctl -u ssh.service

# Filtrar por prioridad (error, warning, etc.)
journalctl -p err

# Mostrar logs desde una fecha especÃ­fica
journalctl --since "2025-06-21 10:00:00"

# Mostrar los Ãºltimos 100 logs
journalctl -n 100

RECURSOS GRATUITOS PARA HOY
Recurso Principal: ExplainShell
URL: https://explainshell.com/
Utilidad:
    â€¢ Pega un comando complejo y te lo desglosa pieza por pieza.
    â€¢ Indispensable para entender y construir "one-liners" de anÃ¡lisis de logs.
Recurso Complementario: Regex101
URL: https://regex101.com/
Utilidad:
    â€¢ Constructor y depurador interactivo de expresiones regulares (RegEx).
    â€¢ Esencial para crear patrones de bÃºsqueda precisos con grep, sed y awk.
Recurso de PrÃ¡ctica: Grep.app
URL: https://grep.app/
Utilidad:
    â€¢ Busca en mÃ¡s de medio millÃ³n de repositorios de GitHub.
    â€¢ Excelente para ver cÃ³mo otros desarrolladores y administradores usan grep en casos reales.
DocumentaciÃ³n Oficial
Acceso: En tu propio terminal.
man grep
man sed
man awk
man journalctl

Utilidad: La fuente de verdad mÃ¡s completa y precisa para cada herramienta.

EJERCICIOS PRÃCTICOS DEL DÃA
Laboratorio 1: AnÃ¡lisis de AutenticaciÃ³n
# 1. Listar todos los intentos de login exitosos para el usuario 'admin'
sudo grep "Accepted password for admin" /var/log/auth.log

# 2. Extraer las direcciones IP de todos los intentos fallidos
sudo grep "Failed password" /var/log/auth.log | awk '{print $(NF-3)}' | sort | uniq

# 3. Contar el nÃºmero de intentos fallidos por IP
sudo grep "Failed password" /var/log/auth.log | awk '{print $(NF-3)}' | sort | uniq -c | sort -nr

# 4. Listar todas las sesiones de sudo iniciadas
sudo grep "session opened for user root by" /var/log/auth.log

# 5. Detectar logins fuera del horario laboral (ej: de 00:00 a 06:00)
sudo journalctl -u ssh --since "today" | grep "Accepted" | grep -E " (00|01|02|03|04|05|06):"

Laboratorio 2: InvestigaciÃ³n de Paquetes
# 1. Ver el historial reciente de instalaciÃ³n de paquetes
grep "install " /var/log/apt/history.log

# 2. Identificar quÃ© usuario instalÃ³ un paquete especÃ­fico (combinando con auth.log)
# (Este es un ejercicio avanzado de correlaciÃ³n)

# 3. Extraer solo los nombres de los paquetes instalados hoy
grep "install " /var/log/apt/history.log | grep "$(date +%Y-%m-%d)" | awk -F' ' '{print $4}'

# 4. Crear un informe de todos los paquetes eliminados del sistema
grep "purge" /var/log/apt/history.log

Laboratorio 3: Monitoreo Activo
# 1. Monitorear en tiempo real los logs de autenticaciÃ³n, buscando errores
sudo tail -f /var/log/auth.log | grep -i "error"

# 2. Crear un "one-liner" que muestre en tiempo real cualquier conexiÃ³n SSH nueva
sudo journalctl -fu sshd | grep "Accepted"

# 3. Crear un script que envÃ­e una alerta si se detecta un intento de login root fallido
cat > ~/root_login_alert.sh << 'EOF'
#!/bin/bash
tail -fn0 /var/log/auth.log | \
while read line ; do
    echo "$line" | grep "Failed password for root"
    if [ $? = 0 ]
    then
        echo "ALERTA: Intento de login root fallido detectado!"
    fi
done
EOF

# 4. Ejecutar el script de monitoreo (se quedarÃ¡ corriendo)
chmod +x ~/root_login_alert.sh
./root_login_alert.sh



ðŸ“Š Progreso general: 7/365 dÃ­as (1.92%)
MaÃ±ana consolidaremos todo lo aprendido esta semana en un laboratorio prÃ¡ctico que simularÃ¡ la configuraciÃ³n de un servidor base completo. Â¡PrepÃ¡rate para demostrar tus nuevas habilidades!
â‚

    1. https://keepcoding.io/blog/que-es-el-analisis-de-logs/    
    2. https://www.iespai.com/2023/09/18/manipulacion-de-texto-en-el-terminal-sintaxis-general-y-ejemplos/    
    3. https://laboratoriolinux.es/index.php/-noticias-mundo-linux-/software/36000-comandos-sed-awk-y-grep-sus-usos-y-ejemplos.html   
    4. https://www.servicepilot.com/es/blog/revision-logs-criticos-analisis-incidentes-seguridad/  
    5. https://www.cosasdelinux.com/general/administracion/logs/ 
